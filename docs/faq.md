# FAQ — Часто задаваемые вопросы

## Общие вопросы

### Как начать работу с проектом?

См. [Быстрый старт](quickstart.md)

Кратко:
```bash
pip install -r requirements.txt
copy .env.example .env
python run_job_once.py
python run_with_scheduler.py
```

### Как часто обновляются данные?

По умолчанию — **ежедневно в 19:10 по Москве** (после закрытия торгов).

Можно изменить в `.env`:
```env
DAILY_RUN_TIME=20:00
```

### Сколько времени занимает генерация отчёта?

Примерно **60-90 секунд** для 15 тикеров (зависит от скорости интернета).

---

## Проблемы с данными

### Пустые свечи / нет данных

**Проблема:** Для некоторых тикеров не получается получить данные.

**Причины:**
1. Тикер торгуется нерегулярно
2. Новая эмиссия (мало истории)
3. Делистинг
4. Временные проблемы с MOEX API

**Решение:**
- Проверьте логи: `data/logs/app.log`
- Проверьте тикер на сайте MOEX
- Удалите проблемные тикеры из `app/config/config.yaml`

**Пример:**
```
[ERROR] Failed to process YNDX: No candle data found for YNDX
```

### Дивиденды не найдены

**Проблема:** `div_ttm: 0.0` для тикера, который платит дивиденды.

**Причины:**
1. Дивиденды не выплачивались последние 12 месяцев
2. Компания приостановила выплаты
3. Данные еще не появились в ISS

**Решение:**
- Проверьте историю дивидендов на moex.com
- Это нормально для некоторых компаний

### Неправильные метрики

**Проблема:** SMA или 52W выглядят странно.

**Причины:**
1. Недостаточно исторических данных (нужно 260+ дней)
2. Корпоративные действия (сплит, дивиденды)
3. Ошибки в данных MOEX

**Решение:**
- Проверьте количество свечей в логах
- Сравните с графиком на moex.com

---

## Проблемы с API

### Задержки ISS API

**Проблема:** Запросы к MOEX API медленные или таймауты.

**Причины:**
1. Высокая нагрузка на ISS (часы торгов)
2. Проблемы с интернетом
3. Rate limiting от MOEX

**Решение:**
- Увеличьте паузу между запросами в `.env`:
  ```env
  MOEX_RATE_LIMIT=0.8
  ```
- Запускайте генерацию после закрытия торгов (19:00+)
- Проверьте логи на ретраи

### Лимиты запросов

**Проблема:** `429 Too Many Requests` или блокировка.

**Решение:**
- Увеличьте `MOEX_RATE_LIMIT` в `.env`
- Уменьшите количество тикеров в `config.yaml`
- Используйте кеширование (сохраненные данные в `data/raw/`)

### API не запускается

**Проблема:** `Address already in use` при запуске.

**Решение:**
```env
# В .env измените порт
API_PORT=8080
```

Или найдите и остановите процесс на порту 8000:
```bash
# Windows
netstat -ano | findstr :8000
taskkill /PID <PID> /F

# Linux
lsof -i :8000
kill <PID>
```

---

## Проблемы с планировщиком

### Планировщик не запускается задачу

**Проблема:** Время пришло, но отчёт не генерируется.

**Причины:**
1. Неправильная временная зона
2. Приложение не запущено
3. Ошибка в расписании

**Решение:**
- Проверьте статус: `GET /scheduler/status`
- Проверьте логи
- Проверьте системное время и TZ
- Запустите вручную: `POST /scheduler/run-now`

### Задача падает с ошибкой

**Проблема:** Планировщик запускается, но падает.

**Решение:**
- Проверьте логи: `data/logs/app.log`
- Проверьте интернет-соединение
- Запустите `python run_job_once.py` для отладки

---

## Проблемы с установкой

### Ошибки при установке зависимостей

**Проблема:** `pip install` падает с ошибками.

**Решение:**
```bash
# Обновите pip
python -m pip install --upgrade pip

# Установите по отдельности проблемные пакеты
pip install pandas
pip install pandas-ta
pip install moexalgo
```

### Конфликты версий

**Проблема:** `pip` сообщает о конфликтах (langchain, pytorch).

**Решение:**
- Это нормально, если у вас установлены другие проекты
- Конфликты не влияют на работу Stock Analytics
- Используйте виртуальное окружение:
  ```bash
  python -m venv venv
  .\venv\Scripts\activate  # Windows
  pip install -r requirements.txt
  ```

### Ошибки импорта модулей

**Проблема:** `ModuleNotFoundError: No module named 'app'`

**Решение:**
```bash
# Запускайте из корневой директории проекта
cd d:\learn\python\stock_analytics

# Или установите PYTHONPATH
set PYTHONPATH=%CD%  # Windows
export PYTHONPATH=$(pwd)  # Linux/Mac
```

---

## Проблемы с данными

### Файл analysis.json не создаётся

**Проблема:** После запуска нет `data/analysis.json`.

**Решение:**
1. Проверьте права доступа к директории `data/`
2. Проверьте логи на ошибки
3. Запустите с DEBUG:
   ```env
   DEBUG=true
   ```

### Старые данные в отчёте

**Проблема:** Отчёт показывает данные вчерашнего дня.

**Причины:**
1. Планировщик еще не запускался сегодня
2. Запланированное время еще не наступило

**Решение:**
- Проверьте время последней генерации в `generated_at`
- Запустите вручную: `python run_job_once.py`
- Или через API: `POST /scheduler/run-now`

---

## Производительность

### Генерация отчёта слишком долгая

**Проблема:** Более 2-3 минут на 15 тикеров.

**Решение:**
- Уменьшите `MOEX_RATE_LIMIT` (осторожно с блокировкой!)
- Уменьшите количество дней в `get_candles(days=400)` → `days=300`
- Проверьте скорость интернета

### Логи занимают много места

**Решение:**
```env
LOG_ROTATION=5 MB      # Ротация чаще
LOG_RETENTION=7 days   # Хранить меньше
```

---

## Разработка

### Тесты не проходят

**Проблема:** `pytest tests/` падает с ошибками.

**Решение:**
1. Убедитесь что все зависимости установлены
2. Запустите конкретный тест:
   ```bash
   pytest tests/test_config.py -v
   ```
3. Проверьте логи тестов

### Как добавить новый тикер?

**Решение:**

Отредактируйте `app/config/config.yaml`:

```yaml
universe:
  - symbol: НОВЫЙ_ТИКЕР
    market: moex
```

Перезапустите приложение.

### Как изменить целевую доходность?

**Решение:**

В `app/config/config.yaml`:

```yaml
dividend_target_pct: 10  # Было 8, стало 10
```

### Как отключить планировщик?

**Решение:**

В `.env`:
```env
SCHEDULER_ENABLED=false
```

Или используйте: `python run_server.py`

---

## Мониторинг

### Как проверить что всё работает?

```bash
# 1. Проверка API
curl http://localhost:8000/api/health

# 2. Проверка планировщика
curl http://localhost:8000/scheduler/status

# 3. Проверка последнего отчёта
curl http://localhost:8000/api/report/summary

# 4. Проверка логов
tail -f data/logs/app.log  # Linux/Mac
Get-Content data/logs/app.log -Wait -Tail 50  # Windows
```

### Как узнать когда будет следующий запуск?

```bash
curl http://localhost:8000/scheduler/status | jq '.data.jobs[0].next_run_time'
```

---

## Интеграции

### Можно ли получать уведомления?

**Сейчас:** Нет встроенных уведомлений.

**Будущие улучшения:**
- Telegram bot
- Email алерты
- Webhook'и

**Временное решение:**
Используйте внешние инструменты для мониторинга API или логов.

### Можно ли экспортировать в Excel?

**Сейчас:** Данные в JSON.

**Решение:**
```python
import pandas as pd
import json

# Загрузить отчёт
with open('data/analysis.json') as f:
    report = json.load(f)

# Конвертировать в DataFrame
df = pd.DataFrame.from_dict(report['by_symbol'], orient='index')

# Сохранить в Excel
df.to_excel('report.xlsx')
```

---

## Безопасность

### API доступен извне?

**По умолчанию:** Да, слушает на `0.0.0.0:8000`

**Для локального доступа:**
```env
API_HOST=127.0.0.1
```

### Нужна ли аутентификация?

**Сейчас:** Нет аутентификации (подходит для локального использования).

**Для продакшена:** Добавьте nginx с basic auth или API ключи.

---

## Дополнительная помощь

### Где искать информацию?

1. **Логи:** `data/logs/app.log`
2. **Документация:** `docs/`
3. **Примеры:** `docs/examples/`
4. **Тесты:** `tests/` (показывают как использовать API)

### Как сообщить о проблеме?

1. Проверьте FAQ (этот файл)
2. Проверьте логи
3. Запустите с `DEBUG=true`
4. Опишите проблему с примером из логов

### Куда расти дальше?

См. `docs/roadmap.md` для идей будущих улучшений.

