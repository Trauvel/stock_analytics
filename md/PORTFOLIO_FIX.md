# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ 422 –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—å —á–µ—Ä–µ–∑ API –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞ **422 Unprocessable Entity** –∏–∑-–∑–∞ —Å—Ç—Ä–æ–≥–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –º–æ–¥–µ–ª–∏ `Position`.

## –ü—Ä–∏—á–∏–Ω—ã

### 1. **–°–∏–º–≤–æ–ª—ã –≤ —Ç–∏–∫–µ—Ä–∞—Ö**
–°—Ç–∞—Ä–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è: `pattern=r'^[A-Z0-9]+$'` - —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã.

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ç–∏–∫–µ—Ä—ã:**
- `TGLD@` - —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∏–º–≤–æ–ª `@`
- `RU000A10AS85` - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ

### 2. **–î–≤–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞**
- –í portfolio.json –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `qty`
- –ú–æ–¥–µ–ª—å –æ–∂–∏–¥–∞–ª–∞ `quantity`

### 3. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è**
–í portfolio.json –±—ã–ª–∏ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –±—ã–ª–æ –≤ –º–æ–¥–µ–ª–∏:
- `name` - –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
- `current_value` - —Ç–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å

### 4. **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞**
–í JSON –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Ç–∏–ø `"fund"` (—Ñ–æ–Ω–¥—ã), –Ω–æ –≤ Enum –±—ã–ª–∏ —Ç–æ–ª—å–∫–æ `stock`, `bond`, `etf`, `currency`.

## –†–µ—à–µ–Ω–∏–µ

### 1. –†–∞—Å—à–∏—Ä–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–∫–µ—Ä–æ–≤
```python
# –ë—ã–ª–æ:
symbol: str = Field(pattern=r'^[A-Z0-9]+$')

# –°—Ç–∞–ª–æ:
symbol: str = Field(min_length=1, max_length=50)  # –†–∞–∑—Ä–µ—à–∞–µ–º –ª—é–±—ã–µ —Å–∏–º–≤–æ–ª—ã
```

–¢–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–∏–∫–µ—Ä—ã —Å:
- –°–ø–µ—Ü—Å–∏–º–≤–æ–ª–∞–º–∏: `TGLD@`, `SBER-$`, `SPB-AAPL`
- –ö–∏—Ä–∏–ª–ª–∏—Ü–µ–π (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è)
- –õ—é–±—ã–º–∏ –¥—Ä—É–≥–∏–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏

### 2. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
```python
quantity: Optional[int] = Field(None, ge=0)
qty: Optional[int] = Field(None, ge=0)  # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫—Ä–∞—Ç–∫–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞

@field_validator('quantity', mode='after')
@classmethod
def sync_quantity(cls, v, info):
    """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è qty –∏ quantity."""
    if v is None and info.data.get('qty') is not None:
        return info.data['qty']
    return v
```

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
- `"quantity": 100` - –ø–æ–ª–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
- `"qty": 100` - –∫—Ä–∞—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç
- –û–±–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É `quantity`)

### 3. –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
```python
name: Optional[str] = None  # –ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
current_value: Optional[float] = None  # –¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
```

### 4. –î–æ–±–∞–≤–ª–µ–Ω —Ç–∏–ø FUND
```python
class PositionType(str, Enum):
    STOCK = "stock"
    BOND = "bond"
    ETF = "etf"
    FUND = "fund"      # ‚≠ê NEW
    CURRENCY = "currency"
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
422 Unprocessable Entity
- pattern check failed for symbol 'TGLD@'
- field required: quantity
- unexpected field: name, current_value
- invalid type: fund
```

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
‚úÖ OK: Loaded 6 positions
Symbols: ['RU000A10AS85', 'SBGB', 'SBMX', 'RTKM', 'YDEX', 'TGLD@']
Types: [bond, fund, fund, stock, stock, fund]
SUCCESS!
```

## –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
```json
{
  "name": "My Portfolio",
  "currency": "RUB",
  "cash": 10000,
  "positions": [
    {
      "symbol": "SBER",
      "qty": 100
    }
  ]
}
```

### –ü–æ–ª–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
```json
{
  "name": "My Portfolio",
  "currency": "RUB",
  "cash": 10000,
  "positions": [
    {
      "symbol": "SBER",
      "quantity": 100,
      "avg_price": 250.50,
      "market": "moex",
      "type": "stock",
      "notes": "–û—Å–Ω–æ–≤–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è",
      "name": "–°–±–µ—Ä–±–∞–Ω–∫",
      "current_value": 25050.00
    }
  ]
}
```

### –°–º–µ—à–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–∫–∞–∫ —É –≤–∞—Å)
```json
{
  "name": "Portfolio",
  "currency": "RUB",
  "cash": 1604.02,
  "positions": [
    {
      "symbol": "TGLD@",
      "name": "–ó–æ–ª–æ—Ç–æ (—Ñ–æ–Ω–¥ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∑–æ–ª–æ—Ç–æ)",
      "qty": 244,
      "avg_price": 12.97,
      "current_value": 3164.68,
      "type": "fund"
    }
  ]
}
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```powershell
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥–µ–ª–∏
python test_portfolio_fix.py

# –ü—Ä–æ–≤–µ—Ä–∫–∞ API
python -m pytest tests/test_api.py::test_save_portfolio -v

# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
python -m pytest tests/test_api.py -v
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ß–µ—Ä–µ–∑ GUI

1. –û—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:8000/static/settings.html`
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "üíº –ü–æ—Ä—Ç—Ñ–µ–ª—å"
3. –†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø–æ–∑–∏—Ü–∏–∏
4. –ù–∞–∂–º–∏—Ç–µ "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—å"

–¢–µ–ø–µ—Ä—å –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç! ‚úÖ

### –ß–µ—Ä–µ–∑ API

```bash
curl -X POST http://localhost:8000/api/portfolio \
  -H "Content-Type: application/json" \
  -d @data/portfolio.json
```

## –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

‚úÖ –°—Ç–∞—Ä—ã–µ –ø–æ—Ä—Ç—Ñ–µ–ª–∏ —Å `quantity` —Ä–∞–±–æ—Ç–∞—é—Ç  
‚úÖ –ù–æ–≤—ã–µ –ø–æ—Ä—Ç—Ñ–µ–ª–∏ —Å `qty` —Ä–∞–±–æ—Ç–∞—é—Ç  
‚úÖ –¢–∏–∫–µ—Ä—ã —Ç–æ–ª—å–∫–æ —Å –±—É–∫–≤–∞–º–∏/—Ü–∏—Ñ—Ä–∞–º–∏ —Ä–∞–±–æ—Ç–∞—é—Ç  
‚úÖ –¢–∏–∫–µ—Ä—ã —Å–æ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–∞–º–∏ —Ä–∞–±–æ—Ç–∞—é—Ç  
‚úÖ –í—Å–µ —Ç–∏–ø—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è  

---

**–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞!** üéâ

